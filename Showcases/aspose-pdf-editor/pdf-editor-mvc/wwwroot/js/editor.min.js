function alertModal(n,t,i,r){t!=null&&t.responseJSON!=null&&(n+=t.responseJSON.detail);r!=null&&(n+=r);$("#errorModal").html(n);$("#loadingModal").modal("hide");$("#errorModal").fadeTo(4e3,500).slideUp(500,function(){$("#errorModal").slideUp(500)})}function saveTextFromArea(){var t=$("#textareaTest").val(),i,n;$("#textAreaPopUp").css("visibility","hidden");t!==""&&(r=0,i=document.getElementById("imageView"),n=i.getContext("2d"),editText===-1?(n.fillStyle=fontColor,n.font=fontStyle+" "+fontWeight+" "+fontSize+"px "+fontText,n.fillText(t,textX,textY+parseInt(fontSize)),tempShape={x:textX,y:textY,w:n.measureText(t).width,h:parseInt(fontSize),p:currentPage,f:Npages[currentPage-1],t:t,n:fontText,s:fontSize,c:fontColor,wt:fontWeight,st:fontStyle,ratio:aRatio[currentPage-1],imfile:"",imName:"",Itype:"text",fieldType:r},shapes.push(tempShape)):(shapes[editText].t=t,shapes[editText].wt=fontWeight,shapes[editText].s=fontSize,shapes[editText].n=fontText,shapes[editText].st=fontStyle,shapes[editText].c=fontColor,shapes[editText].h=parseInt(fontSize),DrawScreen(),DrawShapes(),shapes[editText].w=n.measureText(t).width),n.save(),n.restore())}function DrawPic(n){var t=document.getElementById("imageView"),r,u,i,f;return t.height=pageHeights[n],r=document.getElementById("imageTemp"),r.height=pageHeights[n],u=t.getContext("2d"),u.clearRect(0,0,t.width,t.height),i="",f=Math.random(),i=`${apiBaseUrl}page/preview/${documentId}/${n}`,$("#imageView").css("background-image","url("+i+"?Dummy="+f+")"),!0}function First(){let n=dataLoad.split("%#");Npages=n[0].split(",");aRatio=n[1].split(",");heights=n[2].split(",");fieldData=n.length>3?n[3]:"";addFields(fieldData);for(var t=0;t<heights.length;t++)pageHeights[Npages[t]]=heights[t];($("#hdnOpp").val()==="uploading"||$("#hdnOpp").val()==="dbox"||$("#hdnOpp").val()==="Empty")&&(currentPage=1,onStartup());DrawPic(Npages[currentPage-1]);document.getElementById("lblPages").innerHTML="Page "+currentPage+"  Of "+Npages.length;DrawShapes();ManageFields()}function Next(){if(currentPage<Npages.length){currentPage=currentPage+1;DrawScreen();DrawPic(Npages[currentPage-1]);var n=jQuery.when().promise();n=n.then(wait);n.done(function(){DrawShapes();ManageFields()})}document.getElementById("lblPages").innerHTML="Page "+currentPage+"  Of "+Npages.length}function Previous(){if(currentPage>1){currentPage=currentPage-1;DrawScreen();DrawPic(Npages[currentPage-1]);var n=jQuery.when().promise();n=n.then(wait);n.done(function(){DrawShapes();ManageFields()})}document.getElementById("lblPages").innerHTML="Page "+currentPage+"  Of "+Npages.length}function AddPage(){$("#loadingModal").modal("show");$.ajax({type:"POST",url:`${apiBaseUrl}page/add/${documentId}`,data:'{ "lastpage" : "'+Npages[Npages.length-1]+'" }',contentType:"application/json; charset=utf-8",dataType:"json",success:function(n){datasplit=n.pages.split("#");Npages.push(datasplit[0]);aRatio.push(datasplit[2]);heights.push(datasplit[1]);for(let n=0;n<heights.length;n++)pageHeights[Npages[n]]=heights[n];document.getElementById("lblPages").innerHTML="Page "+currentPage+"  Of "+Npages.length},error:function(n,t,i){alertModal("Error: ",n,t,i)}}).done(function(){$("#loadingModal").modal("hide")})}function DeletePage(){function n(n){return n==currentPage}$("#loadingModal").modal("show");shapes=shapes.filter(n);var t=JSON.stringify({pageNumber:currentPage,documentId:documentId});return $.ajax({type:"DELETE",url:`${apiBaseUrl}page/delete`,data:t,contentType:"application/json; charset=utf-8",dataType:"json",success:function(){updateIndexesDelete()},error:function(n,t,i){alertModal("Error: ",n,t,i)}}).done(function(){$("#loadingModal").modal("hide")})}function updateIndexesDelete(){DeleteShapes();Npages.splice(currentPage-1,1);currentPage>Npages.length&&(currentPage=Npages.length);DrawPic(Npages[currentPage-1]);document.getElementById("lblPages").innerHTML="Page "+currentPage+"  Of "+Npages.length}function DeleteShapes(){for(let n=0;n<shapes.length;n++)shapes[n].p===Npages[currentPage-1]&&shapes.splice(n,1)}function DelShape(){$("#divDel").css("visibility","hidden");DrawScreen();shapes.splice(selectedShape,1);DrawShapes();selectedShape=-1}function wait(){var n=jQuery.Deferred(),t=setInterval(function(){clearInterval(t);n.resolve()},100);return n.promise()}function ReplaceText(){let n=$("#txtFind").val(),t=$("#txtReplace").val(),i=JSON.stringify({txtFind:n,txtReplace:t,pageList:Npages,documentId:documentId});$("#loadingModal").modal("show");$.ajax({type:"PUT",url:`${apiBaseUrl}text/replace`,data:i,contentType:"application/json; charset=utf-8",dataType:"json",success:function(){AfterSearch()},error:function(n,t,i){alertModal("Error: ",n,t,i)}}).done(function(){$("#loadingModal").modal("hide")})}function Move(){let n=$("#txtMove").val();$("#hdnMove").val()==="moving"?(movedata=JSON.stringify({moveFrom:currentPage.toString(),moveTo:n,pageList:Npages,documentId:documentId}),$("#loadingModal").modal("show"),$.ajax({type:"PUT",url:`${apiBaseUrl}page/move`,data:movedata,contentType:"application/json; charset=utf-8",dataType:"json",success:function(n){Npages=n.pageList;MoveUpdate()},error:function(n,t,i){alertModal("Error: ",n,t,i)}}).done(function(){$("#loadingModal").modal("hide")})):($("#loadingModal").modal("show"),movedata=JSON.stringify({searchText:n,pageList:Npages,documentId:documentId}),$.ajax({type:"POST",url:`${apiBaseUrl}text/search`,data:movedata,contentType:"application/json; charset=utf-8",dataType:"json",success:function(){AfterSearch()},error:function(n,t,i){alertModal("Error: ",n,t,i)}}).done(function(){$("#loadingModal").modal("hide")}))}function moveClick(n){n.preventDefault();GeneralSetup("Move")}function appendClick(n){n.preventDefault();GeneralSetup("Append")}function clearSearchClicked(){let n=JSON.stringify({searchText:"",pageList:Npages,documentId:documentId});$.ajax({type:"DELETE",url:`${apiBaseUrl}text/clear`,data:n,contentType:"application/json; charset=utf-8",dataType:"json",success:function(){AfterSearch()},error:function(n,t,i){alertModal("Error: ",n,t,i)}}).done(function(){$("#loadingModal").modal("hide")})}function AfterSearch(){DrawScreen();DrawPic(Npages[currentPage-1]);var n=jQuery.when().promise();n=n.then(wait);n.done(function(){DrawShapes()})}function btnExportClick(){$.ajax({type:"POST",url:`${apiBaseUrl}export-pdf`,data:"{}",contentType:"application/json; charset=utf-8",dataType:"json"})}function MoveUpdate(){for(var t,n=0;n<Npages.length;n++)for(t=0;t<shapes.length;t++)Npages[n]===shapes[t].f&&(shapes[t].p=n+1);DrawScreen();DrawPic(Npages[currentPage-1]);DrawShapes();document.getElementById("lblPages").innerHTML="Page "+currentPage+"  Of "+Npages.length}function SavePdf(){$("#loadingModal").modal("show");let t="image".concat(currentPage).concat(".png");shapes2=[];for(var n=0;n<shapes.length;n++)tempShape={x:shapes[n].x.toString(),y:shapes[n].y.toString(),w:shapes[n].w.toString(),h:shapes[n].h.toString(),p:shapes[n].p.toString(),f:shapes[n].f.toString(),t:shapes[n].t.toString(),n:shapes[n].n.toString(),s:shapes[n].s.toString(),c:shapes[n].c.toString(),wt:shapes[n].wt.toString(),st:shapes[n].st.toString(),ratio:shapes[n].ratio.toString(),imfile:"",imName:shapes[n].imName,Itype:shapes[n].Itype.toString(),fieldType:shapes[n].fieldType.toString()},shapes2.push(tempShape);wholedata=JSON.stringify({shapes:shapes2,filename:t,aspectRatio:ratio.toString(),documentId:documentId});$.ajax({type:"POST",url:`${apiBaseUrl}shape/add`,data:wholedata,contentType:"application/json; charset=utf-8",dataType:"json",success:function(){$("#savingModal").fadeTo(2e3,500).slideUp(500,function(){$("#savingModal").slideUp(500)})},error:function(n,t,i){alertModal("Error: ",n,t,i)}}).done(function(){$("#loadingModal").modal("hide")})}function DrawScreen(){let n=document.getElementById("imageView"),t=n.getContext("2d");t.clearRect(0,0,n.width,n.height);document.getElementById("imageTemp").getContext("2d").clearRect(0,0,n.width,n.height)}function DrawShapes(){var i;let t=document.getElementById("imageView"),n=t.getContext("2d");for(let t=0;t<shapes.length;t++)if(shapes[t].f===Npages[currentPage-1]&&(shapes[t].Itype==="highlight"&&(n.fillStyle="rgba(255, 230, 81, 0.5)",n.fillRect(shapes[t].x,shapes[t].y,shapes[t].w,shapes[t].h)),shapes[t].Itype==="image"&&(i="Images/".concat(shapes[t].imfile),imageObj=shapes[t].imfile,n.drawImage(imageObj,shapes[t].x,shapes[t].y,shapes[t].w,shapes[t].h)),shapes[t].Itype==="text")){n.save();n.translate(shapes[t].x,shapes[t].y+parseInt(shapes[t].s));n.rotate(shapes[t].fieldType);var r=shapes[t].n,u=shapes[t].s,f=shapes[t].wt,e=shapes[t].st;n.fillStyle=shapes[t].c;n.font=e+" "+f+" "+u+"px "+r;n.fillText(shapes[t].t,0,0);n.restore()}}function fileSelected(){$("#uploadModal").modal("hide");let t=new FormData;t.append("fileToUpload",document.getElementById("fileToUpload").files[0]);t.append("Opp",$("#hdnOpp").val());typeof documentId!="undefined"&&documentId!="undefined"&&t.append("documentId",documentId);$("#hdnOpp").val()==="appending"&&(t.append("pages",Npages),t.append("ratios",aRatio),t.append("heights",heights));var n=new XMLHttpRequest;console.log($("#hdnOpp").val());switch($("#hdnOpp").val()){case"uploading":n.open("PUT",`${apiBaseUrl}document/upload`);break;case"appending":n.open("PUT",`${apiBaseUrl}document/append`);break;case"addAttachment":n.open("POST",`${apiBaseUrl}attachment/add`)}n.upload.onprogress=function(n){n.lengthComputable&&$(".progress-bar").width("60%")};n.onreadystatechange=function(){if(n.readyState===4){if(n.status>=300){alertModal(n.statusText);return}if(data=JSON.parse(n.responseText),dataLoad=data.pages,documentId=data.documentId,$("#hdnOpp").val()==="appending")First();else if($("#hdnOpp").val()==="uploading"){for(i=0;i<shapes.length;i++){var t=document.getElementById("div_"+shapes[i].imName+""),r=document.getElementById(shapes[i].imName);r!==null&&$("#"+shapes[i].imName+"").remove();t!==null&&t.parentNode.removeChild(t)}shapes2.length=0;shapes.length=0;Attachments.length=0;GetAttachments();First()}else $("#hdnOpp").val()==="addAttachment"?GetAttachments():InsertImages(data.pages,50,50);$(".progress-bar").width("100%");$("#fileToUpload").wrap("<form>").parent("form").trigger("reset");$("#fileToUpload").unwrap();$("#fileToUpload").prop("files")[0]=null;$("#fileToUpload").replaceWith($("#fileToUpload"));$(".progress-bar").width("0%")}};n.send(t)}function anchorHitTest(n,t,i,r){if(anchorVal=-1,t>n.x&&t<n.x+10&&i<n.y+10&&i>n.y&&n.Itype==="image")return anchorVal=0;if(t>n.x+n.w-10&&t<n.x+n.w&&i<n.y+10&&i>n.y&&n.Itype==="image")return anchorVal=1;if(t>n.x&&t<n.x+10&&i>n.y+n.h-10&&i<n.y+n.h&&n.Itype==="image")return anchorVal=2;if(t>n.x+n.w-10&&t<n.x+n.w&&i>n.y+n.h-10&&i<n.y+n.h&&n.Itype==="image")return anchorVal=3;if(t>n.x+n.w-5&&t<n.x+n.w+5&&i<n.y+n.h/2+10&&i>n.y+n.h/2-10&&n.Itype==="text")return anchorVal=5;if(n.Itype==="text"){r.save();r.translate(n.x,n.y+parseInt(n.s));r.rotate(n.fieldType);r.beginPath();r.rect(n.w-5,n.h/-2-5,10,10);var u=r.isPointInPath(t,i);return r.restore(),u&&(anchorVal=5),anchorVal}return-1}function hitTest(n,t,i,r){if(n.Itype==="text"){r.save();r.translate(n.x,n.y+parseInt(n.s));r.rotate(n.fieldType);r.beginPath();r.rect(0,-n.h,n.w+5,n.h);var u=r.isPointInPath(t,i);return r.restore(),u}return t>n.x&&t<n.x+n.w?i>n.y&&i<n.y+n.h?!0:!1:!1}function InsertImages(n,t,i){let r=document.getElementById("imageView"),e=r.getContext("2d"),s=r.getBoundingClientRect(),o=`${apiBaseUrl}page/preview/${documentId}/${n}?Dummy=${Math.random()}`,u=0,f=0;imageObj=new Image;imageObj.onload=function(){e.drawImage(imageObj,t,i);u=this.width;f=this.height;tempShape={x:t,y:i,w:u,h:f,p:currentPage,f:Npages[currentPage-1],t:"",n:"",s:"",c:"",wt:"",st:"",ratio:aRatio[currentPage-1],imfile:imageObj,imName:n,Itype:"image",fieldType:""};shapes.push(tempShape)};imageObj.src=o;imageObj.style.zIndex=500+shapes.length}function ExportByType(n,t){const i=document.createElement("a");i.href=`${apiBaseUrl}document/download/${n}/${t}`;i.download=`${apiBaseUrl}}document/download/${n}/${t}`.split("/").pop()+"."+n;document.body.appendChild(i);i.click();document.body.removeChild(i)}function ExportFile(n){$("#loadingModal").modal("show");$.ajax({type:"POST",url:`${apiBaseUrl}document/export?fileType=${n}&folder=${documentId}`,contentType:"application/json; charset=utf-8",dataType:"json",success:function(){ExportByType(n,documentId)},error:function(n,t,i){alertModal("Error: ",n,t,i)}}).done(function(){$("#loadingModal").modal("hide")})}function ddFontChange(){let n=document.getElementById("ddFont");fontText=n.options[n.selectedIndex].value;$("#textareaTest").css("font-family",fontText)}function ddSizeChange(){let n=document.getElementById("ddSize");fontSize=n.options[n.selectedIndex].value;$("#textareaTest").css("font-size",fontSize+"px")}function makeBold(){$("#btnBold").hasClass("active")?($("#textareaTest").css("font-weight","normal"),fontWeight="normal"):($("#textareaTest").css("font-weight","bold"),fontWeight="bold")}function makeItalic(){$("#btnItalic").hasClass("active")?($("#textareaTest").css("font-style","italic"),fontStyle=""):($("#textareaTest").css("font-style","italic"),fontStyle="italic")}function selectColor(n){$("#textareaTest").css("color",n.name);$("#btnColor").css("background-color",n.name);fontColor=n.name;$("#myColors").modal("hide")}function closeTextEditor(){$("#textAreaPopUp").css("visibility","hidden")}function GeneralSetup(n){for(i=0;i<shapes.length;i++)if(shapes[i].f===Npages[currentPage-1]&&shapes[i].Itype==="field"){let n=document.getElementById(shapes[i].imName);if(n!==null)if(shapes[i].fieldType==="Text")shapes[i].t=n.value;else if(shapes[i].fieldType==="ComboBox"){let t=n.value;for(x=0;x<n.options.length;x++)t=t+"^^^"+n.options[x].value;shapes[i].t=t}else(shapes[i].fieldType==="CheckBox"||shapes[i].fieldType==="Radio")&&(shapes[i].t=n.checked)}$("#textAreaPopUp").css("visibility","hidden");$("#divDel").css("visibility","hidden");$("#divSignature").css("visibility","hidden");DrawScreen();DrawShapes();currentTools=n}function moveModeClose(){$("#hdnMove").val("")}function addFields(n){if(n!==""){var t=n.split("$#$");for(i=0;i<t.length;i++)tempShape={x:t[i+0],y:t[i+1],w:t[i+2],h:t[i+3],p:t[i+4],f:t[i+5],t:t[i+6],n:t[i+7],s:t[i+8],c:t[i+9],wt:t[i+10],st:t[i+11],ratio:t[i+12],imfile:t[i+13],imName:t[i+14],Itype:"field",fieldType:t[i+15]},shapes.push(tempShape),i=i+15}}function ManageFields(){var s,l,c,y,f,a,n,t,u,r,i,e,h,v,o;for(let n=0;n<shapes.length;n++)s=document.getElementById("div_"+shapes[n].imName+""),l=document.getElementById(shapes[n].imName),l!==null&&$("#"+shapes[n].imName+"").remove(),s!==null&&s.parentNode.removeChild(s);c=document.getElementById("imageView");y=c.getContext("2d");for(let s=0;s<shapes.length;s++)if(shapes[s].f===Npages[currentPage-1]&&shapes[s].Itype==="field"&&(f=c.getBoundingClientRect(),a=document.getElementById("div_"+shapes[s].imName+""),a===null)){if(n=document.createElement("div"),n.style.left=f.left+parseInt(shapes[s].x)+2+"px",n.style.top=f.top+parseInt(shapes[s].y)+2+"px",n.style.width=parseInt(shapes[s].w-2)+"px",n.style.height=parseInt(shapes[s].h-2)+"px",n.id="div_"+shapes[s].imName,n.style.zIndex=50+s,shapes[s].fieldType==="Text")n.className="info",n.setAttribute("display","block"),t=document.createElement("textarea"),t.className="tbox",t.value=shapes[s].t,t.style.width=parseInt(shapes[s].w)-2+"px",t.style.height=parseInt(shapes[s].h)-2+"px",t.style.left="0px",t.style.top="0px",t.style.zIndex=150+s,shapes[s].st==="True"&&(t.style.backgroundColor="#FFE4E1"),t.id=shapes[s].imName,n.appendChild(t);else if(shapes[s].fieldType==="CheckBox")n.className="info",n.style.left=f.left+parseInt(shapes[s].x)+"px",n.style.top=f.top+parseInt(shapes[s].y)+"px",n.style.width=parseInt(shapes[s].w)+5+"px",n.style.height=parseInt(shapes[s].h)+5+"px",shapes[s].st==="True"&&(n.style.backgroundColor="#FFE4E1"),u=document.createElement("input"),u.type="checkbox",u.name=shapes[s].imfile,u.checked=shapes[s].t==="true"?!0:!1,u.style.zIndex=150+s,u.id=shapes[s].imName,n.appendChild(u);else if(shapes[s].fieldType==="Radio")n.className="Mine",n.style.left=f.left+parseInt(shapes[s].x)+"px",n.style.top=f.top-1+parseInt(shapes[s].y)+"px",n.style.width=parseInt(shapes[s].w)+5+"px",n.style.height=parseInt(shapes[s].h)+5+"px",shapes[s].st==="True"&&(n.style.backgroundColor="#FFE4E1"),r=document.createElement("input"),r.type="radio",r.id=shapes[s].imName,r.name=shapes[s].imfile,r.checked=shapes[s].t==="true"?!0:!1,r.style.zIndex=150+s,r.id=shapes[s].imName,n.appendChild(r);else if(shapes[s].fieldType==="ComboBox"){for(n.className="tbox",i=document.createElement("select"),i.id=shapes[s].imName,i.style.zIndex=150+s,e=shapes[s].t.split("^^^"),i.className="tbox",i.style.width=shapes[s].w-2+"px",shapes[s].st==="True"&&(i.style.backgroundColor="#FFE4E1"),j=1;j<e.length;j++)h=document.createElement("option"),h.value=e[j],h.innerHTML=e[j],i.appendChild(h);if(e[0]!=="")for(v=i.options.length,o=0;o<v;o++)if(i.options[o].value===e[0]){i.options[o].selected=!0;break}n.appendChild(i)}document.body.appendChild(n)}}function GetAttachments(){$.ajax({type:"GET",url:`${apiBaseUrl}attachment/all/${documentId}`,data:{documentId:documentId},contentType:"application/json; charset=utf-8",dataType:"json",success:function(n){var t,r;for(Attachments=n.files.split(","),t=document.getElementById("tblAttach");t.rows.length>1;)t.deleteRow(1);for(r=1,i=0;i<Attachments.length-1;i++){var u=t.insertRow(t.rows.length),f=u.insertCell(0),e=u.insertCell(1),o=u.insertCell(2),s=u.insertCell(3);f.innerHTML=Attachments[i];e.innerHTML=Attachments[i+1];let n=Attachments[i].lastIndexOf("."),h=Attachments[i].substr(0,n)+"_"+Attachments[i].substr(n+1);o.innerHTML=`<a href="${apiBaseUrl}GetFileAttachment/${documentId}/${h}" download class="btn btn-default" role="button">Download</a>`;name=Attachments[i];button=document.createElement("input");button.setAttribute("type","button");button.setAttribute("name",r);button.setAttribute("value","Remove");button.setAttribute("class","btn btn-danger");button.onclick=function(){let n=name,t=r;return function(){RemoveAttachment(n,t)}}();s.appendChild(button);r=r+1;i=i+1}},error:function(n,t,i){alertModal("Error: ",n,t,i)}}).done(function(){$("#loadingModal").modal("hide")})}function RemoveAttachment(n,t){let i=JSON.stringify({attachmentFileName:n,documentId:documentId});$.ajax({type:"DELETE",url:`${apiBaseUrl}attachment/remove`,data:i,contentType:"application/json; charset=utf-8",dataType:"json",success:function(){document.getElementById("tblAttach").deleteRow(t)},error:function(n,t,i){alertModal("Error: ",n,t,i)}}).done(function(){$("#loadingModal").modal("hide")})}function GetFileExists(){var n=typeof folderName!="undefined"&&window.folderName!="undefined"?window.folderName:"",t=typeof fileName!="undefined"&&window.fileName!="undefined"?window.fileName:"";$.ajax({type:"GET",url:`${apiBaseUrl}document/info?folder=${n}&fileName=${t}`,contentType:"application/json; charset=utf-8",dataType:"json",success:function(n){dataLoad=n.pages;documentId=n.documentId;console.log(n);for(let n=0;n<shapes.length;n++){var t=document.getElementById("div_"+shapes[n].imName+""),i=document.getElementById(shapes[n].imName);i!==null&&$("#"+shapes[n].imName+"").remove();t!==null&&t.parentNode.removeChild(t)}$("#hdnOpp").val("Empty");shapes2.length=0;shapes.length=0;Attachments.length=0;$("#loadingModal").modal("hide");First()},error:function(n,t,i){alertModal("Error: ",n,t,i)}}).done(function(){$("#loadingModal").modal("hide")})}function newFileClick(){$.ajax({type:"POST",url:`${apiBaseUrl}document/create`,contentType:"application/json; charset=utf-8",dataType:"json",success:function(n){for(dataLoad=n.pages,documentId=n.documentId,i=0;i<shapes.length;i++){var t=document.getElementById("div_"+shapes[i].imName+""),r=document.getElementById(shapes[i].imName);r!==null&&$("#"+shapes[i].imName+"").remove();t!==null&&t.parentNode.removeChild(t)}$("#hdnOpp").val("Empty");shapes2.length=0;shapes.length=0;Attachments.length=0;First()},error:function(n,t,i){alertModal("Error: ",n,t,i)}}).done(function(){$("#loadingModal").modal("hide")})}function clearSignature(){const t=document.querySelector("#signCanvas");t.width=t.width;const n=t.getContext("2d");n.lineWidth=5;n.lineJoin="round";n.lineCap="round";n.strokeStyle="blue"}function saveSignature(){const t=document.querySelector("#signCanvas"),i=t.toDataURL("image/png");var n=new FormData;n.append("documentId",documentId);t.toBlob(function(t){n.append(i,t,"signature.png");$.ajax({type:"POST",url:`${apiBaseUrl}shape/upload`,data:n,processData:!1,contentType:!1,success:function(n){InsertImages(n.pages,signX,signY);$("#divSignature").css("visibility","hidden");currentTools="dragging";document.getElementById("btnDrag").click();var t=jQuery.Event("mousedown",{pageX:signX,pageY:signY});$("#imageView").trigger(t)}}).done(function(){$("#loadingModal").modal("hide")})},"image/png")}function closeSignature(){$("#divSignature").css("visibility","hidden")}function onStartup(){document.getElementById("btnAddPage").disabled=!1;document.getElementById("btnDeletePage").disabled=!1;document.getElementById("btnMoving").disabled=!1;document.getElementById("btnAppending").disabled=!1;document.getElementById("btnSave").disabled=!1;document.getElementById("btnExporting").disabled=!1;document.getElementById("btnPrevious").disabled=!1;document.getElementById("btnNext").disabled=!1;document.getElementById("btnSearching").disabled=!1;document.getElementById("btnImage").disabled=!1;document.getElementById("btnRect").disabled=!1;document.getElementById("btnRead").disabled=!1;document.getElementById("btnDrag").disabled=!1;document.getElementById("btnTexting").disabled=!1;document.getElementById("btnAttachments").disabled=!1;document.getElementById("btnSignature").disabled=!1}function drawRotationHandle(n,t){t.save();t.translate(n.x,n.y+parseInt(n.s));t.rotate(n.fieldType);t.strokeStyle="brown";t.setLineDash([6]);t.strokeRect(0,-n.h,n.w,n.h);t.fillStyle="#7171C6";t.fillRect(n.w-5,n.h/-2-5,10,10);t.restore()}let apiBaseUrl="/api/",documentId="",ratio=1,canvasHeight,canvasWidth,currentPage,Npages=[],aRatio=[],dataLoad,shapes=[],shapes2=[],Attachments=[],fontText="Arial",fontSize=16,fontWeight="",fontStyle="",fontColor="black",mouseX,mouseY,textX,textY,editText=-1,imageObj,selectedShape=-1,searchFolder="",pageHeights={},heights,currentTools="reading",anchorVal=-1,signX=5,signY=5,r=0,isDown=!1,tool,tool_default;window.addEventListener&&window.addEventListener("load",function(){function b(){var i;if(e=document.getElementById("imageView"),e.width=canvasWidth,e.height=canvasHeight,l=0,a=0,v=0,y=0,tool_default="reading",!e){alertModal("Error: I cannot find the canvas element!");return}if(!e.getContext){alertModal("Error: no canvas.getContext!");return}if(c=e.getContext("2d"),!c){alertModal("Error: failed to getContext!");return}if(i=e.parentNode,t=document.createElement("canvas"),!t){alertModal("Error: I cannot create a new canvas element!");return}t.id="imageTemp";t.display="none";t.width=e.width;t.height=e.height;i.appendChild(t);u=t.getContext("2d");var n=document.getElementById("btnRect"),r=document.getElementById("btnRead"),o=document.getElementById("btnDrag"),s=document.getElementById("btnTexting"),h=document.getElementById("btnSignature");if(!n){alertModal("Error: failed to get the dtool element!");return}n.addEventListener("click",k);r.addEventListener("click",d);o.addEventListener("click",g);s.addEventListener("click",nt);h.addEventListener("click",tt);f[tool_default]&&(tool=new f[tool_default],n.value=tool_default);t.addEventListener("mousedown",p,!1);t.addEventListener("mousemove",p,!1);t.addEventListener("mouseup",p,!1);GetFileExists()}function p(n){n.layerX||n.layerX===0?(n._x=n.layerX,n._y=n.layerY):(n.offsetX||n.offsetX===0)&&(n._x=n.offsetX,n._y=n.offsetY);let t=tool[n.type];t&&t(n)}function k(){f.rect&&currentTools==="Rect"&&(tool=new f.rect)}function d(){f.reading&&currentTools==="Read"&&(tool=new f.reading)}function g(){f.dragging&&currentTools==="Drag"&&(tool=new f.dragging)}function nt(){f.texting&&(tool=new f.texting)}function tt(){f.signature&&currentTools==="signature"&&(tool=new f.signature)}function it(){c.drawImage(t,0,0);u.clearRect(0,0,t.width,t.height)}let t,u,e,c,l,a,v,y,w=0,n,o,s,h;canvasWidth=1138;canvasHeight=760;$("#loadingModal").modal("show");var f={};f.rect=function(){let n=this;this.started=!1;this.mousedown=function(t){currentTools==="Rect"&&(n.started=!0,n.x0=t._x,n.y0=t._y)};this.mousemove=function(i){if(n.started){var e=Math.min(i._x,n.x0),o=Math.min(i._y,n.y0),r=Math.abs(i._x-n.x0),f=Math.abs(i._y-n.y0);(u.clearRect(0,0,t.width,t.height),r&&f)&&(u.fillStyle="rgba(255, 230, 81, 0.5)",u.fillRect(e,o,r,f),l=e,a=o,v=r,y=f,w=w+1)}};this.mouseup=function(t){n.started&&(n.mousemove(t),n.started=!1,it(),tempShape={x:l,y:a,w:v,h:y,p:currentPage,f:Npages[currentPage-1],t:"",n:"",s:"",c:"",wt:"",st:"",ratio:aRatio[currentPage-1],imfile:"",imName:"",Itype:"highlight",fieldType:""},shapes.push(tempShape))}};f.signature=function(){tool=this;this.started=!1;this.mousedown=function(n){var o;let f=t.getBoundingClientRect();mouseX=(n.clientX-f.left)*(t.width/f.width);mouseY=(n.clientY-f.top)*(t.height/f.height);$("#divSignature").css("visibility","visible");$("#divSignature").css("left",mouseX);$("#divSignature").css("top",mouseY);signX=mouseX;signY=mouseY;var i=document.querySelector("#signCanvas"),r=i.getContext("2d"),u={x:0,y:0},e={x:0,y:0};i.addEventListener("mousemove",function(n){e.x=u.x;e.y=u.y;var t=i.getBoundingClientRect();u.x=(n.clientX-t.left)*(i.width/t.width);u.y=(n.clientY-t.top)*(i.height/t.height)},!1);r.lineWidth=5;r.lineJoin="round";r.lineCap="round";r.strokeStyle="blue";i.addEventListener("mousedown",function(){i.addEventListener("mousemove",o,!1)},!1);i.addEventListener("mouseup",function(){i.removeEventListener("mousemove",o,!1)},!1);o=function(){r.beginPath();r.moveTo(e.x,e.y);r.lineTo(u.x,u.y);r.closePath();r.stroke()}}};f.reading=function(){tool=this;this.started=!1};f.dragging=function(){tool=this;this.started=!1;this.mousedown=function(i){var r,f,e;if(currentTools==="Drag"){tool.started=!0;tool.x0=i._x;tool.y0=i._y;f=-1;let c=t.getBoundingClientRect();for(mouseX=(i.clientX-c.left)*(t.width/c.width),mouseY=(i.clientY-c.top)*(t.height/c.height),r=0;r<shapes.length;r++)if(hitTest(shapes[r],mouseX,mouseY,u)){if(anchorHitTest(shapes[r],mouseX,mouseY,u)===-1?(o=!0,anchorVal=-1,isDown=!1):shapes[r].Itype==="image"?(o=!1,isDown=!1):shapes[r].Itype==="text"&&anchorVal===5?(o=!1,isDown=!0):(o=!0,anchorVal=-1,isDown=!1),selectedShape=r,r>f){s=mouseX-shapes[r].x;h=mouseY-shapes[r].y;f=r;n=r;e=t.getBoundingClientRect();shapes[n].Itype!=="text"&&(u.strokeStyle="brown",u.setLineDash([6]),u.strokeRect(shapes[n].x,shapes[n].y,shapes[n].w,shapes[n].h));shapes[n].Itype==="image"?(u.fillStyle="rgba(255, 230, 81, 1)",u.fillRect(shapes[n].x,shapes[n].y,10,10),u.fillRect(shapes[n].x+shapes[n].w-10,shapes[n].y,10,10),u.fillRect(shapes[n].x,shapes[n].y+shapes[n].h-10,10,10),u.fillRect(shapes[n].x+shapes[n].w-10,shapes[n].y+shapes[n].h-10,10,10)):shapes[n].Itype==="text"&&drawRotationHandle(shapes[n],u);mouseX=i.pageX-t.offsetLeft;mouseY=i.pageY-t.offsetTop;$("#divDel").css("visibility","visible");$("#divDel").css("left",e.left+shapes[n].x-50);$("#divDel").css("top",e.top+shapes[n].y);break}}else $("#divDel").css("visibility","hidden"),document.getElementById("imageView").getContext("2d").width=document.getElementById("imageTemp").getContext("2d").width,DrawScreen(),DrawShapes();return i.preventDefault?i.preventDefault():i.returnValue&&(i.returnValue=!1),!1}};this.mousemove=function(i){var e,c,f;if(tool.started)if(o)f=t.getBoundingClientRect(),mouseX=(i.clientX-f.left)*(t.width/f.width),mouseY=(i.clientY-f.top)*(t.height/f.height),e=mouseX-s,c=mouseY-h,shapes[n].x=e,shapes[n].y=c,t.width=t.width,DrawScreen(),DrawShapes(),mouseX=i.pageX-t.offsetLeft,mouseY=i.pageY-t.offsetTop,shapes[n].Itype!=="text"&&(u.strokeStyle="brown",u.setLineDash([6]),u.strokeRect(shapes[n].x,shapes[n].y,shapes[n].w,shapes[n].h)),shapes[n].Itype==="image"?(u.fillStyle="rgba(255, 230, 81, 1)",u.fillRect(shapes[n].x,shapes[n].y,10,10),u.fillRect(shapes[n].x+shapes[n].w-10,shapes[n].y,10,10),u.fillRect(shapes[n].x,shapes[n].y+shapes[n].h-10,10,10),u.fillRect(shapes[n].x+shapes[n].w-10,shapes[n].y+shapes[n].h-10,10,10)):shapes[n].Itype==="text"&&drawRotationHandle(shapes[n],u),$("#divDel").css("visibility","hidden");else if(isDown){let e,o,f=t.getBoundingClientRect();mouseX=(i.clientX-f.left)*(t.width/f.width);mouseY=(i.clientY-f.top)*(t.height/f.height);e=mouseX-s;o=mouseY-h;var l=mouseX-shapes[n].x+shapes[n].w/2,a=mouseY-shapes[n].y+shapes[n].h/2,v=Math.atan2(a,l);r=v;shapes[n].fieldType=r;DrawScreen();DrawShapes();drawRotationHandle(shapes[n],u)}else{let r,f,e=t.getBoundingClientRect();mouseX=(i.clientX-e.left)*(t.width/e.width);mouseY=(i.clientY-e.top)*(t.height/e.height);r=mouseX-s;f=mouseY-h;imgWidth=shapes[n].x+shapes[n].w;imgHeight=shapes[n].y+shapes[n].h;switch(anchorVal){case 0:shapes[n].x=r;shapes[n].y=f;shapes[n].w=imgWidth-r;shapes[n].h=imgHeight-f;break;case 1:shapes[n].y=f;shapes[n].w=shapes[n].w-(imgWidth-mouseX);shapes[n].h=imgHeight-f;break;case 2:shapes[n].x=r;shapes[n].w=imgWidth-r;shapes[n].h=shapes[n].h-(imgHeight-mouseY);break;case 3:shapes[n].w=shapes[n].w-(imgWidth-mouseX);shapes[n].h=shapes[n].h-(imgHeight-mouseY)}shapes[n].w<25&&(shapes[n].w=25);shapes[n].h<25&&(shapes[n].h=25);t.width=t.width;DrawScreen();DrawShapes();shapes[n].Itype!=="text"?(u.strokeStyle="brown",u.setLineDash([6]),u.strokeRect(shapes[n].x,shapes[n].y,shapes[n].w,shapes[n].h)):shapes[n].Itype==="text"&&drawRotationHandle(shapes[n],u);shapes[n].Itype==="image"&&(u.fillStyle="rgba(255, 230, 81, 1)",u.fillRect(shapes[n].x,shapes[n].y,10,10),u.fillRect(shapes[n].x+shapes[n].w-10,shapes[n].y,10,10),u.fillRect(shapes[n].x,shapes[n].y+shapes[n].h-10,10,10),u.fillRect(shapes[n].x+shapes[n].w-10,shapes[n].y+shapes[n].h-10,10,10));mouseX=i.pageX-t.offsetLeft;mouseY=i.pageY-t.offsetTop;$("#divDel").css("visibility","hidden")}};this.mouseup=function(){if(tool.started&&(tool.started=!1),isDown=!1,o){var i=t.getBoundingClientRect();$("#divDel").css("visibility","visible");$("#divDel").css("left",i.left+shapes[n].x-50);$("#divDel").css("top",i.top+shapes[n].y);o=!1}}};f.texting=function(){let n=this;this.started=!1;this.mousedown=function(r){if(currentTools==="Text"){for(n.started=!0,n.x0=r._x,n.y0=r._y,textX=r._x,textY=r._y,$("#textareaTest").val(""),i=0;i<shapes.length;i++)if(shapes[i].t!=="")if(hitTest(shapes[i],textX,textY,u)){editText=i;$("#textareaTest").val(shapes[i].t);break}else editText=-1;mouseX=r.pageX-t.offsetLeft;mouseY=r.pageY-t.offsetTop;$("#textAreaPopUp").css("visibility","visible");$("#textAreaPopUp").css("left",mouseX);$("#textAreaPopUp").css("top",mouseY);var f=$("#textareaTest");f.focus()}};this.mousemove=function(){!n.started};this.mouseup=function(){n.started&&(n.started=!1);o&&(o=!1)}};$("#myColors").on("shown.bs.modal",function(){$("#myColors").modal().css("top",$("#textAreaPopUp").position().top);$("#myColors").modal().css("left",$("#textAreaPopUp").position().left)});$(".btn-group > .btn").click(function(){$(".btn-group > .btn").removeClass("active");$(this).addClass("active")});b()},!1);$(document).on("click",".open-uploadModal",function(){let n=$(this).data("id");console.log(n);$("#hdnOpp").val(n)});$(document).on("click",".open-moveModal",function(){let n=$(this).data("id");$("#hdnMove").val(n);n==="searching"?($("#btnMove").html("Search"),$("#H1").html("Search Text"),$("#lblpagemove").html("Enter Text to Search")):($("#btnMove").html("Move"),$("#H1").html("Move Page After"),$("#lblpagemove").html("Enter Page Number"))});